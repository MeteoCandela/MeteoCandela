<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendari Hort Valls (Alt Camp) — Quinzenes</title>
  <meta name="description" content="Calendari de sembra/plantació/trasplantament/collita per quinzenes — Valls (Alt Camp)." />
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:rgba(255,255,255,.10);

      --si:#60a5fa;   /* SI */
      --se:#34d399;   /* SE (inclou PLANTACIÓ per tubercles/bulbs) */
      --tr:#fbbf24;   /* TR */
      --co:#f472b6;   /* CO */
      --today: rgba(255,255,255,.12);
      --todayLine: rgba(255,255,255,.28);

      --bad:#fb7185;
      --warnbg: rgba(251,113,133,.12);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7fb;
        --panel:#ffffff;
        --panel2:#ffffff;
        --text:#0b1220;
        --muted:#4b5563;
        --border:rgba(0,0,0,.12);
        --today: rgba(0,0,0,.06);
        --todayLine: rgba(0,0,0,.18);
        --warnbg: rgba(251,113,133,.10);
      }
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 12px 28px}
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(to bottom, var(--bg) 70%, transparent);
      backdrop-filter:saturate(1.2) blur(8px);
      padding:12px 0 10px;
    }
    h1{font-size:18px;margin:0;line-height:1.2}
    .sub{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.35}

    .controls{margin-top:10px;display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 900px){.controls{grid-template-columns:1.4fr .9fr .7fr .7fr}}
    input, select, button{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border); background:var(--panel); color:var(--text);
      font-size:14px; outline:none;
    }
    button{cursor:pointer}
    button:hover{filter:brightness(1.05)}
    .row2{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (min-width: 900px){.row2{grid-template-columns:.9fr .7fr .7fr .7fr}}
    .pillrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px; border-radius:999px;
      background:var(--panel); border:1px solid var(--border);
      font-size:12px; color:var(--muted); user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:3px; display:inline-block}
    .dot.si{background:var(--si)}
    .dot.se{background:var(--se)}
    .dot.tr{background:var(--tr)}
    .dot.co{background:var(--co)}
    .pill strong{color:var(--text);font-weight:650}

    .meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:10px 0 8px;color:var(--muted);font-size:12px}
    .banner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--warnbg);
      color:var(--text);
      font-size:12px;
      line-height:1.35;
      display:none;
    }
    .banner b{color:var(--bad)}
    .banner code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    .list{display:flex; flex-direction:column; gap:10px}
    details.card{background:var(--panel2);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    summary{
      list-style:none; cursor:pointer; padding:12px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    summary::-webkit-details-marker{display:none}
    .left{min-width:0;display:flex;flex-direction:column;gap:4px}
    .name{font-weight:650;font-size:15px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tags{display:flex; gap:6px; flex-wrap:wrap}
    .tag{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid var(--border); color:var(--muted);
      background:rgba(255,255,255,.03);
    }
    .tag.bad{color:var(--bad); border-color: rgba(251,113,133,.35)}
    .group{font-size:11px;color:var(--muted);white-space:nowrap}

    .body{padding:0 12px 12px}
    .notes{font-size:12px;color:var(--muted);margin:8px 0 10px;line-height:1.35}

    .gridwrap{
      overflow:auto; -webkit-overflow-scrolling: touch;
      border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,.02);
    }
    .grid{
      min-width: 920px;
      display:grid;
      grid-template-columns: 140px repeat(24, 1fr);
    }
    .gcell{
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      padding:8px 6px;
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .gcell.head{
      position:sticky; top:0; z-index:3;
      background:var(--panel2); color:var(--text);
      font-weight:650; text-align:center;
    }
    .gcell.lefthead{position:sticky;left:0;z-index:4;background:var(--panel2);text-align:left}
    .gcell.rowlabel{position:sticky;left:0;z-index:2;background:var(--panel2);color:var(--text);font-weight:700}
    .q{font-size:11px;padding:8px 0}
    .bar{padding:0;height:34px;position:relative;background:transparent}
    .seg{
      position:absolute; top:6px; bottom:6px; left:6px; right:6px;
      border-radius:10px; opacity:.92;
      border:1px solid rgba(255,255,255,.18);
    }
    @media (prefers-color-scheme: light){
      .seg{border:1px solid rgba(0,0,0,.12)}
    }
    .seg.si{background:var(--si)}
    .seg.se{background:var(--se)}
    .seg.tr{background:var(--tr)}
    .seg.co{background:var(--co)}
    .todaycol{background:var(--today) !important;}
    .todayhdr{box-shadow: inset 0 -2px 0 var(--todayLine);}

    .footer{margin-top:14px;font-size:12px;color:var(--muted);line-height:1.35}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      padding:2px 6px; border-radius:8px; border:1px solid var(--border); background:rgba(255,255,255,.03);}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Calendari hortícola — Valls (Alt Camp) — per quinzenes</h1>
        <div class="sub">
          **SE** inclou també <b>PLANTACIÓ</b> (patata, all, calçot, etc.) perquè al calendari d’hort es consulta igual que “sembra a exterior”.
          Salt a data → marca la quinzena i centra la graella.
        </div>
      </div>

      <div class="controls">
        <input id="q" type="search" placeholder="Cerca cultiu… (ex: patata, tomàquet, coliflor)" autocomplete="off" />
        <select id="group"><option value="">Tots els grups</option></select>
        <select id="phase">
          <option value="">Totes les fases</option>
          <option value="SI">Només SI</option>
          <option value="SE">Només SE (sembra/plantació)</option>
          <option value="TR">Només TR</option>
          <option value="CO">Només CO</option>
        </select>
        <button id="expand">Expandir/Contraure tot</button>
      </div>

      <div class="row2">
        <input id="date" type="date" />
        <button id="goDate">Anar a la data</button>
      </div>

      <div class="pillrow" aria-label="Llegenda">
        <span class="pill"><span class="dot si"></span><strong>SI</strong> (interior)</span>
        <span class="pill"><span class="dot se"></span><strong>SE</strong> (exterior / plantació)</span>
        <span class="pill"><span class="dot tr"></span><strong>TR</strong> (trasplant)</span>
        <span class="pill"><span class="dot co"></span><strong>CO</strong> (collita)</span>
      </div>

      <div class="meta">
        <div id="count"></div>
        <div id="selInfo"></div>
      </div>

      <div class="banner" id="banner"></div>
    </header>

    <main>
      <div class="list" id="list"></div>
      <div class="footer">
        Tip: dins d’un cultiu, scroll horitzontal. Salt a data: <span class="kbd">Anar a la data</span>.
      </div>
    </main>
  </div>

<script>
  // --- Eix temporal ---
  const ORDER = ["G1","G2","F1","F2","Mç1","Mç2","A1","A2","Mg1","Mg2","Jn1","Jn2","Jl1","Jl2","Ag1","Ag2","S1","S2","O1","O2","N1","N2","D1","D2"];
  const POS = Object.fromEntries(ORDER.map((k,i)=>[k,i+1]));
  const MONTHS = [
    {m:1,label:"Gen",start:1},{m:2,label:"Feb",start:3},{m:3,label:"Mar",start:5},{m:4,label:"Abr",start:7},
    {m:5,label:"Mai",start:9},{m:6,label:"Jun",start:11},{m:7,label:"Jul",start:13},{m:8,label:"Ago",start:15},
    {m:9,label:"Set",start:17},{m:10,label:"Oct",start:19},{m:11,label:"Nov",start:21},{m:12,label:"Des",start:23},
  ];
  function quinzenaFromDate(d){
    const m = d.getMonth()+1;
    const day = d.getDate();
    const half = (day <= 15) ? 1 : 2;
    return (m-1)*2 + half;
  }

  // --- IMPORTANT: normalització per “plantacions” ---
  // En aquests cultius, el que al CSV s’havia posat com TR (plantació) es vol veure a SE (exterior/plantació).
  const PLANTACIO_TO_SE = [
    "Patata",
    "Patata tardana",
    "All",
    "Calçot (plantació bulb)"
  ];

  // --- Dades (les mateixes que tens; no les torno a re-explicar) ---
  const DATA = [
    {"cultiu":"Tomàquet","SI_ini":"F1","SI_fi":"Mç2","SE_ini":"","SE_fi":"","TR_ini":"A2","TR_fi":"Mg2","CO_ini":"Jn2","CO_fi":"O2","icones":"SF;RG;VN","notes":"A1 possible amb protecció (P). Tutoratge; mulch; reg regular."},
    {"cultiu":"Pebrot","SI_ini":"F1","SI_fi":"Mç2","SE_ini":"","SE_fi":"","TR_ini":"Mg1","TR_fi":"Mg2","CO_ini":"Jl1","CO_fi":"O2","icones":"SF;RG;VN","notes":"A2 possible amb protecció (P) i microclima arrecerat. Molt sensible al fred."},
    {"cultiu":"Albergínia","SI_ini":"F1","SI_fi":"Mç2","SE_ini":"","SE_fi":"","TR_ini":"Mg1","TR_fi":"Jn1","CO_ini":"Jl1","CO_fi":"O2","icones":"SF;RG;VN","notes":"A2 possible amb protecció (P). Necessita calor sostinguda."},
    {"cultiu":"Tomàquet de penjar","SI_ini":"F1","SI_fi":"Mç2","SE_ini":"","SE_fi":"","TR_ini":"A2","TR_fi":"Mg2","CO_ini":"Jl1","CO_fi":"O2","icones":"SF;RG;VN","notes":"Mateix calendari; collita orientada a conservació."},
    {"cultiu":"Carbassó","SI_ini":"Mç2","SI_fi":"A2","SE_ini":"A2","SE_fi":"Jn1","TR_ini":"A2","TR_fi":"Jn1","CO_ini":"Jn2","CO_fi":"S2","icones":"SF;RG","notes":"A1 possible amb P. Vigilar oïdi; collir sovint."},
    {"cultiu":"Cogombre","SI_ini":"A1","SI_fi":"A2","SE_ini":"Mg1","SE_fi":"Jn1","TR_ini":"Mg1","TR_fi":"Jn1","CO_ini":"Jn2","CO_fi":"S2","icones":"SF;RG","notes":"Tutoratge si enfiladís; sensible al fred."},
    {"cultiu":"Meló","SI_ini":"A1","SI_fi":"A2","SE_ini":"Mg1","SE_fi":"Mg2","TR_ini":"Mg1","TR_fi":"Mg2","CO_ini":"Jl2","CO_fi":"S2","icones":"SF;RG","notes":"Reg controlat; reduir a final per dolçor."},
    {"cultiu":"Síndria","SI_ini":"A1","SI_fi":"A2","SE_ini":"Mg1","SE_fi":"Mg2","TR_ini":"Mg1","TR_fi":"Mg2","CO_ini":"Ag1","CO_fi":"S2","icones":"SF;RG","notes":"Molt termòfila; sòl drenat."},
    {"cultiu":"Carbassa","SI_ini":"A1","SI_fi":"A2","SE_ini":"Mg1","SE_fi":"Jn1","TR_ini":"Mg1","TR_fi":"Jn1","CO_ini":"S2","CO_fi":"N2","icones":"SF;RG","notes":"Molt espai; collir amb pell dura."},
    {"cultiu":"Carbassó d'hivern","SI_ini":"A1","SI_fi":"A2","SE_ini":"Mg1","SE_fi":"Jn1","TR_ini":"Mg1","TR_fi":"Jn1","CO_ini":"S2","CO_fi":"N2","icones":"SF;RG","notes":"Varietats de guarda; similar a carbassa."},
    {"cultiu":"Mongeta tendra","SI_ini":"A2","SI_fi":"Mg2","SE_ini":"A2","SE_fi":"Jl2","TR_ini":"Mg1","TR_fi":"Jn1","CO_ini":"Jn2","CO_fi":"O1","icones":"SF","notes":"Escalonar sembres cada 2–3 setmanes; germina amb sòl calent."},
    {"cultiu":"Mongeta seca","SI_ini":"","SI_fi":"","SE_ini":"Mg1","SE_fi":"Jn2","TR_ini":"","TR_fi":"","CO_ini":"S1","CO_fi":"O2","icones":"","notes":"Sembra per gra; assecat a planta si el temps ho permet."},
    {"cultiu":"Pèsol","SI_ini":"","SI_fi":"","SE_ini":"O1","SE_fi":"F2","TR_ini":"","TR_fi":"","CO_ini":"Mç1","CO_fi":"Mg2","icones":"","notes":"Tutoratge; ideal tardor-hivern. Mç1 possible amb varietat primerenca."},
    {"cultiu":"Fava","SI_ini":"","SI_fi":"","SE_ini":"O1","SE_fi":"G2","TR_ini":"","TR_fi":"","CO_ini":"Mç2","CO_fi":"Jn1","icones":"","notes":"Molt adequada a hivern; tutoratge en varietats altes."},
    {"cultiu":"Enciam","SI_ini":"F1;Ag2","SI_fi":"Jn1;O2","SE_ini":"Mç1;S1","SE_fi":"Mg2;O2","TR_ini":"Mç2;S2","TR_fi":"Jn2;N1","CO_ini":"A2;O1","CO_fi":"Jl2;D2","icones":"OM","notes":"A ple estiu (Jn2–Ag1) ombra/varietats d’estiu per evitar espigat. D1–G2 possible amb P."},
    {"cultiu":"Espinac","SI_ini":"","SI_fi":"","SE_ini":"S1","SE_fi":"Mç2","TR_ini":"","TR_fi":"","CO_ini":"O1","CO_fi":"A2","icones":"OM","notes":"Evitar estiu; A1 possible amb P segons any."},
    {"cultiu":"Bleda","SI_ini":"F1;Ag1","SI_fi":"A2;S2","SE_ini":"Mç1;Ag2","SE_fi":"Jn1;S2","TR_ini":"A1;S1","TR_fi":"Jn2;O2","CO_ini":"Mg1","CO_fi":"D2","icones":"OM","notes":"G1–F2 possible amb P en hivern fred."},
    {"cultiu":"Canonges","SI_ini":"","SI_fi":"","SE_ini":"S2","SE_fi":"N2","TR_ini":"","TR_fi":"","CO_ini":"N2","CO_fi":"Mç2","icones":"","notes":"A1 possible amb P; creixement lent."},
    {"cultiu":"Rúcula","SI_ini":"","SI_fi":"","SE_ini":"F2;S1","SE_fi":"Jn1;N1","TR_ini":"","TR_fi":"","CO_ini":"Mç1;S2","CO_fi":"Jn2;D2","icones":"OM","notes":"Bon cultiu escalonat; tendeix a espigar amb calor."},
    {"cultiu":"Escarola","SI_ini":"Ag2","SI_fi":"O2","SE_ini":"S1","SE_fi":"O2","TR_ini":"S2","TR_fi":"N1","CO_ini":"N1","CO_fi":"F2","icones":"","notes":"Mç1 possible amb P. Bona per tardor-hivern."},
    {"cultiu":"Endívia (arrel + forçat)","SI_ini":"","SI_fi":"","SE_ini":"Mg1","SE_fi":"Jn2","TR_ini":"","TR_fi":"","CO_ini":"S1","CO_fi":"O1","icones":"","notes":"Arrel: CO S1–O1. Forçat: CO O1–D2 (segons maneig)."},
    {"cultiu":"Col (repols)","SI_ini":"F2;Jl2","SI_fi":"A2;S2","SE_ini":"","SE_fi":"","TR_ini":"A2;S1","TR_fi":"Jn1;N2","CO_ini":"Jn1;N1","CO_fi":"Jl2;Mç2","icones":"","notes":"A1 possible amb P. Producció principal tardor-hivern."},
    {"cultiu":"Coliflor","SI_ini":"Jn2;G2","SI_fi":"S1;F2","SE_ini":"","SE_fi":"","TR_ini":"Ag1","TR_fi":"O1","CO_ini":"N1","CO_fi":"Mç2","icones":"","notes":"Primerenca amb P (G2–F2). Evitar pics de calor."},
    {"cultiu":"Bròcoli","SI_ini":"Jl2","SI_fi":"S2","SE_ini":"","SE_fi":"","TR_ini":"Ag2","TR_fi":"N1","CO_ini":"N2","CO_fi":"A2","icones":"","notes":"Collir cap principal i rebrots."},
    {"cultiu":"Bròquil (brotonera)","SI_ini":"Ag1","SI_fi":"S2","SE_ini":"","SE_fi":"","TR_ini":"S1","TR_fi":"O2","CO_ini":"N1","CO_fi":"A2","icones":"","notes":"Varietat dependent; molt d’hivern-inici primavera."},
    {"cultiu":"Col de Brussel·les","SI_ini":"Mç2","SI_fi":"A2","SE_ini":"","SE_fi":"","TR_ini":"Mg1","TR_fi":"Jn1","CO_ini":"N1","CO_fi":"F2","icones":"","notes":"Mç1 possible amb P. Necessita cicle llarg."},
    {"cultiu":"Kale / col arrissada","SI_ini":"Mç2;Jl2","SI_fi":"A2;S2","SE_ini":"","SE_fi":"","TR_ini":"Mg1;S1","TR_fi":"Jn1;N1","CO_ini":"O1","CO_fi":"Mç2","icones":"","notes":"A1 possible amb P. Rústica."},
    {"cultiu":"Pastanaga","SI_ini":"","SI_fi":"","SE_ini":"F2;Ag2","SE_fi":"Jn2;O2","TR_ini":"","TR_fi":"","CO_ini":"Mg1","CO_fi":"N2","icones":"","notes":"Millor sòl fi; aclarida."},
    {"cultiu":"Remolatxa","SI_ini":"","SI_fi":"","SE_ini":"F2;Ag2","SE_fi":"Jn2;O2","TR_ini":"","TR_fi":"","CO_ini":"Mg1","CO_fi":"N2","icones":"","notes":"Primavera i tardor ideals."},
    {"cultiu":"Nap","SI_ini":"","SI_fi":"","SE_ini":"S1;F2","SE_fi":"N2;Mç2","TR_ini":"","TR_fi":"","CO_ini":"O1;A2","CO_fi":"G2;Mg2","icones":"","notes":"Cicle ràpid en temps fresc."},
    {"cultiu":"Rave","SI_ini":"","SI_fi":"","SE_ini":"F2;S1","SE_fi":"Jn2;N2","TR_ini":"","TR_fi":"","CO_ini":"Mç1;S2","CO_fi":"Jl2;D2","icones":"","notes":"Escalonar sembres; evita calor intensa."},
    {"cultiu":"Xirivia","SI_ini":"","SI_fi":"","SE_ini":"Mç1","SE_fi":"Jn1","TR_ini":"","TR_fi":"","CO_ini":"S1","CO_fi":"F2","icones":"","notes":"Cicle llarg; aguanta fred; Mç1 possible amb P."},
    {"cultiu":"Patata","SI_ini":"","SI_fi":"","SE_ini":"","SE_fi":"","TR_ini":"F2","TR_fi":"Mç2","CO_ini":"Jn1","CO_fi":"Jl1","icones":"","notes":"Ag1–Ag2 plantació tardana amb CO N1–N2. Risc gelada si massa d’hora."},
    {"cultiu":"Patata tardana","SI_ini":"","SI_fi":"","SE_ini":"Ag1","SE_fi":"Ag2","TR_ini":"","TR_fi":"","CO_ini":"N1","CO_fi":"N2","icones":"","notes":"Cicle tardà; necessita reg i control míldiu."},
    {"cultiu":"Ceba bulb","SI_ini":"G2","SI_fi":"Mç2","SE_ini":"","SE_fi":"","TR_ini":"F2","TR_fi":"A2","CO_ini":"Jn1","CO_fi":"Ag2","icones":"","notes":"Varietat determinant; curat en sec per guardar."},
    {"cultiu":"Ceba tendra","SI_ini":"S1;G2","SI_fi":"N1;Mç2","SE_ini":"","SE_fi":"","TR_ini":"O1;F2","TR_fi":"D1;A2","CO_ini":"N1","CO_fi":"Mg1","icones":"","notes":"Cicle per ceba tendra; ajustar segons varietat."},
    {"cultiu":"All","SI_ini":"","SI_fi":"","SE_ini":"","SE_fi":"","TR_ini":"O1","TR_fi":"G2","CO_ini":"Jn1","CO_fi":"Jl2","icones":"","notes":"Evitar excés d’aigua al final; rotació."},
    {"cultiu":"Porro","SI_ini":"F1;Ag1","SI_fi":"A2;S2","SE_ini":"","SE_fi":"","TR_ini":"Mg1;O1","TR_fi":"Jl2;N1","CO_ini":"O1","CO_fi":"Mç2","icones":"","notes":"A1 possible amb P. Aporcar per blanquejar."},
    {"cultiu":"Api","SI_ini":"F1","SI_fi":"A1","SE_ini":"","SE_fi":"","TR_ini":"A2","TR_fi":"Jn1","CO_ini":"Jl1","CO_fi":"N2","icones":"RG","notes":"Exigent d’aigua; pateix calor extrema."},
    {"cultiu":"Fonoll","SI_ini":"","SI_fi":"","SE_ini":"Ag2","SE_fi":"O2","TR_ini":"","TR_fi":"","CO_ini":"N1","CO_fi":"F2","icones":"","notes":"Mç1 possible amb P. Millor a tardor-hivern."},
    {"cultiu":"Blat de moro dolç","SI_ini":"","SI_fi":"","SE_ini":"A2","SE_fi":"Jn1","TR_ini":"","TR_fi":"","CO_ini":"Jl2","CO_fi":"S2","icones":"SF;RG","notes":"Sembra en blocs per pol·linització; reg clau."},
    {"cultiu":"Gira-sol","SI_ini":"","SI_fi":"","SE_ini":"Mç2","SE_fi":"Mg2","TR_ini":"","TR_fi":"","CO_ini":"Ag1","CO_fi":"S2","icones":"","notes":"Baix manteniment; espai i sol."},
    {"cultiu":"Alfàbrega","SI_ini":"Mç2","SI_fi":"Mg2","SE_ini":"","SE_fi":"","TR_ini":"Mg1","TR_fi":"Jn1","CO_ini":"Jn1","CO_fi":"S2","icones":"SF","notes":"No fred; ideal amb tomàquet."},
    {"cultiu":"Julivert","SI_ini":"","SI_fi":"","SE_ini":"F1;S1","SE_fi":"Jn2;N2","TR_ini":"","TR_fi":"","CO_ini":"A1","CO_fi":"D2","icones":"","notes":"G1–F2 possible amb P; germinació lenta."},
    {"cultiu":"Cilantre","SI_ini":"","SI_fi":"","SE_ini":"F2;S1","SE_fi":"Mg2;O2","TR_ini":"","TR_fi":"","CO_ini":"Mç2;S2","CO_fi":"Jn1;N1","icones":"","notes":"A calor espiga; millor primavera/tardor."},
    {"cultiu":"Anet","SI_ini":"","SI_fi":"","SE_ini":"Mç1;S1","SE_fi":"Jn1;O1","TR_ini":"","TR_fi":"","CO_ini":"A2;S2","CO_fi":"Jl2;N2","icones":"","notes":"Fàcil; escalonar."},
    {"cultiu":"Farigola (plantació)","SI_ini":"","SI_fi":"","SE_ini":"Mç1","SE_fi":"Mg2","TR_ini":"","TR_fi":"","CO_ini":"Mg1","CO_fi":"O2","icones":"","notes":"Perenne; collita principal primavera-estiu."},
    {"cultiu":"Romaní (plantació)","SI_ini":"","SI_fi":"","SE_ini":"Mç1","SE_fi":"Mg2","TR_ini":"","TR_fi":"","CO_ini":"Mg1","CO_fi":"O2","icones":"","notes":"Perenne; podes lleugeres."},
    {"cultiu":"Sàlvia (plantació)","SI_ini":"","SI_fi":"","SE_ini":"Mç1","SE_fi":"Mg2","TR_ini":"","TR_fi":"","CO_ini":"Mg1","CO_fi":"O2","icones":"","notes":"Perenne; collita principal primavera-estiu."},
    {"cultiu":"Orenga (plantació)","SI_ini":"","SI_fi":"","SE_ini":"Mç1","SE_fi":"Mg2","TR_ini":"","TR_fi":"","CO_ini":"Mg1","CO_fi":"O2","icones":"","notes":"Perenne; millor en sol i drenatge."},
    {"cultiu":"Menta (plantació)","SI_ini":"","SI_fi":"","SE_ini":"Mç1","SE_fi":"Jn1","TR_ini":"","TR_fi":"","CO_ini":"Mg1","CO_fi":"O2","icones":"RG","notes":"S’expandeix; millor en test o delimitada."},
    {"cultiu":"Calçot (plantació bulb)","SI_ini":"","SI_fi":"","SE_ini":"Ag1","SE_fi":"S2","TR_ini":"","TR_fi":"","CO_ini":"N1","CO_fi":"Mç2","icones":"","notes":"Aporcats S2–N1 (diverses vegades). Pics D1–F2."},
    {"cultiu":"Ceba mare per calçot (si la produeixes)","SI_ini":"G2","SI_fi":"Mç2","SE_ini":"","SE_fi":"","TR_ini":"F2","TR_fi":"A2","CO_ini":"Jn1","CO_fi":"Ag2","icones":"","notes":"Bulb per replantar com a calçot a Ag1–S2."}
  ];

  // --- Grup heurístic ---
  function groupOf(name){
    const n = name.toLowerCase();
    if (n.includes("calçot")) return "Calçot";
    if (["tomàquet","pebrot","albergínia"].some(x=>n.includes(x))) return "Solanàcies (estiu)";
    if (["carbass","cogombre","meló","síndria"].some(x=>n.includes(x))) return "Cucurbitàcies (estiu)";
    if (["mongeta","pèsol","fava"].some(x=>n.includes(x))) return "Lleguminoses";
    if (["enciam","espinac","bleda","canonges","rúcula","escarola","endívia"].some(x=>n.includes(x))) return "Fulla";
    if (["col","bròcoli","bròquil","kale","brussel"].some(x=>n.includes(x))) return "Brassicàcies";
    if (["pastanaga","remolatxa","nap","rave","xirivia","patata"].some(x=>n.includes(x))) return "Arrels";
    if (["ceba","all","porro","api","fonoll"].some(x=>n.includes(x))) return "Bulbs i tiges";
    if (["blat de moro","gira-sol"].some(x=>n.includes(x))) return "Altres (grans)";
    if (["alfàbrega","julivert","cilantre","anet","farigola","romaní","sàlvia","orenga","menta"].some(x=>n.includes(x))) return "Aromàtiques";
    return "Altres";
  }
  DATA.forEach(d=>d.grup = groupOf(d.cultiu));

  // --- Parser intervals ---
  function parseIntervals(a,b){
    if(!a || !b) return [];
    const A = String(a).split(";").map(s=>s.trim()).filter(Boolean);
    const B = String(b).split(";").map(s=>s.trim()).filter(Boolean);
    let aList=A, bList=B;
    if (aList.length===1 && bList.length>1) aList = new Array(bList.length).fill(aList[0]);
    if (bList.length===1 && aList.length>1) bList = new Array(aList.length).fill(bList[0]);
    const n = Math.min(aList.length, bList.length);
    const out=[];
    for(let i=0;i<n;i++){
      const s=aList[i], e=bList[i];
      if(POS[s] && POS[e]) out.push([POS[s], POS[e]]);
      else out.push(["INVALID", s, e]);
    }
    return out;
  }

  // --- Validació exhaustiva i normalització ---
  const VALIDATION = { errors: [] };

  function normalizeCrop(d){
    // Clona per no mutar l’objecte original
    const x = JSON.parse(JSON.stringify(d));

    // 1) Normalització de plantació -> SE
    if (PLANTACIO_TO_SE.includes(x.cultiu)){
      // si no hi ha SE, però hi ha TR, mou TR cap a SE
      if ((!x.SE_ini && !x.SE_fi) && (x.TR_ini && x.TR_fi)){
        x.SE_ini = x.TR_ini;
        x.SE_fi  = x.TR_fi;
        x.TR_ini = "";
        x.TR_fi  = "";
        x.notes = (x.notes ? x.notes + " " : "") + "[Nota tècnica: TR reassignat a SE perquè és PLANTACIÓ.]";
      }
    }
    return x;
  }

  function validateAll(){
    VALIDATION.errors = [];
    for(const d0 of DATA){
      const d = normalizeCrop(d0);

      const fields = ["SI","SE","TR","CO"];
      for(const ph of fields){
        const ini = d[ph+"_ini"], fi = d[ph+"_fi"];
        const parsed = parseIntervals(ini, fi);
        for(const it of parsed){
          if (it[0]==="INVALID"){
            VALIDATION.errors.push({cultiu:d.cultiu, fase:ph, ini:it[1], fi:it[2]});
          }
        }
      }

      // comprova incoherències bàsiques (fi abans que ini)
      const phases = ["SI","SE","TR","CO"];
      for(const ph of phases){
        const parsed = parseIntervals(d[ph+"_ini"], d[ph+"_fi"]);
        for(const it of parsed){
          if (Array.isArray(it) && it.length===2){
            const s=it[0], e=it[1];
            if (typeof s==="number" && typeof e==="number" && e < s){
              VALIDATION.errors.push({cultiu:d.cultiu, fase:ph, ini:d[ph+"_ini"], fi:d[ph+"_fi"], msg:"fi < ini"});
            }
          }
        }
      }
    }
  }

  function buildSegments(d0){
    const d = normalizeCrop(d0);
    const phases = ["SI","SE","TR","CO"];
    const segs=[];
    for (const ph of phases){
      const parsed = parseIntervals(d[ph+"_ini"], d[ph+"_fi"]);
      for (const it of parsed){
        if (Array.isArray(it) && it.length===2){
          segs.push({ph, s:it[0], e:it[1]});
        }
      }
    }
    return { d, segs };
  }

  // --- UI ---
  const $ = (id)=>document.getElementById(id);
  const listEl = $("list");
  const groupEl = $("group");
  const qEl = $("q");
  const phaseEl = $("phase");
  const countEl = $("count");
  const expandBtn = $("expand");
  const dateEl = $("date");
  const goDateBtn = $("goDate");
  const selInfo = $("selInfo");
  const banner = $("banner");

  let selectedCol = quinzenaFromDate(new Date());

  function updateSelInfo(){
    const qCode = ORDER[selectedCol-1];
    const m = Math.ceil(selectedCol/2);
    const half = (selectedCol%2===1) ? "1a" : "2a";
    const monthLabel = MONTHS.find(x=>x.m===m)?.label || "";
    selInfo.textContent = `Quinzena marcada: ${monthLabel} (${half}) · codi ${qCode}`;
  }

  // Grup select
  const groups = Array.from(new Set(DATA.map(d=>groupOf(d.cultiu)))).sort((a,b)=>a.localeCompare(b,'ca'));
  for(const g of groups){
    const opt=document.createElement("option");
    opt.value=g; opt.textContent=g;
    groupEl.appendChild(opt);
  }

  // Date input = avui
  (function(){
    const d=new Date();
    const pad=n=>String(n).padStart(2,'0');
    dateEl.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    updateSelInfo();
  })();

  function makeMonthHeader(){
    const frag=document.createDocumentFragment();
    let cell=document.createElement("div");
    cell.className="gcell head lefthead";
    cell.textContent="Fase";
    frag.appendChild(cell);

    for(let i=1;i<=24;i++){
      const q = ORDER[i-1];
      const monthStart = MONTHS.find(x=>x.start===i);
      const text = monthStart ? monthStart.label : q;
      cell=document.createElement("div");
      cell.className="gcell head q" + (i===selectedCol ? " todaycol todayhdr" : "");
      cell.textContent = text;
      cell.title = q;
      frag.appendChild(cell);
    }
    return frag;
  }

  function buildGrid(d0, onlyPhase){
    const { d, segs } = buildSegments(d0);

    const gridWrap=document.createElement("div");
    gridWrap.className="gridwrap";

    const header=document.createElement("div");
    header.className="grid";
    header.appendChild(makeMonthHeader());
    gridWrap.appendChild(header);

    const phases = [
      {ph:"SI", label:"SI"},
      {ph:"SE", label:"SE (ext/plantació)"},
      {ph:"TR", label:"TR"},
      {ph:"CO", label:"CO"}
    ];

    for(const P of phases){
      if (onlyPhase && P.ph!==onlyPhase) continue;

      const row=document.createElement("div");
      row.className="grid";

      const lab=document.createElement("div");
      lab.className="gcell rowlabel";
      lab.textContent = P.label;
      row.appendChild(lab);

      for(let i=1;i<=24;i++){
        const cell=document.createElement("div");
        const inside = segs.some(s => s.ph===P.ph && i>=s.s && i<=s.e);
        cell.className="gcell bar" + (i===selectedCol ? " todaycol" : "");
        if(inside){
          const block=document.createElement("div");
          block.className="seg " + P.ph.toLowerCase();
          cell.appendChild(block);
        }
        row.appendChild(cell);
      }
      gridWrap.appendChild(row);
    }

    // Centrar la col seleccionada
    requestAnimationFrame(()=>{
      const leftCol = 140;
      const colWidth = (gridWrap.scrollWidth - leftCol) / 24;
      const targetX = leftCol + (selectedCol-1)*colWidth - (gridWrap.clientWidth/2) + (colWidth/2);
      gridWrap.scrollLeft = Math.max(0, targetX);
    });

    return { gridWrap, normalized: d };
  }

  function iconTags(d0){
    const d = normalizeCrop(d0);
    const icons = (d.icones||"").split(";").map(s=>s.trim()).filter(Boolean);
    const tags=[];
    tags.push(d.grup);
    for(const i of icons) tags.push(i);
    if ((d.notes||"").includes("(P)")) tags.push("P");
    // tag d’error si aquest cultiu té intervals invàlids
    const hasErr = VALIDATION.errors.some(e=>e.cultiu===d.cultiu);
    if (hasErr) tags.push("⚠ dades");
    return tags;
  }

  function render(){
    const q = qEl.value.trim().toLowerCase();
    const g = groupEl.value;
    const onlyPhase = phaseEl.value;

    let items = DATA.slice();
    if (g) items = items.filter(d=>groupOf(d.cultiu)===g);
    if (q){
      items = items.filter(d=>{
        const dN = normalizeCrop(d);
        const hay = (dN.cultiu + " " + (dN.notes||"") + " " + (dN.icones||"") + " " + groupOf(dN.cultiu)).toLowerCase();
        return hay.includes(q);
      });
    }
    if (onlyPhase){
      items = items.filter(d=>{
        const { segs } = buildSegments(d);
        return segs.some(s=>s.ph===onlyPhase);
      });
    }

    countEl.textContent = `${items.length} cultius`;
    listEl.innerHTML="";

    items.sort((a,b)=>{
      const ga=groupOf(a.cultiu).localeCompare(groupOf(b.cultiu),'ca');
      if (ga!==0) return ga;
      return a.cultiu.localeCompare(b.cultiu,'ca');
    });

    for(const d0 of items){
      const d = normalizeCrop(d0);

      const card=document.createElement("details");
      card.className="card";

      const sum=document.createElement("summary");
      const left=document.createElement("div");
      left.className="left";

      const name=document.createElement("div");
      name.className="name";
      name.textContent=d.cultiu;

      const tags=document.createElement("div");
      tags.className="tags";
      for(const t of iconTags(d)){
        const el=document.createElement("span");
        el.className="tag" + (t==="⚠ dades" ? " bad" : "");
        el.textContent=t;
        tags.appendChild(el);
      }

      left.appendChild(name);
      left.appendChild(tags);

      const right=document.createElement("div");
      right.className="group";
      right.textContent=groupOf(d.cultiu);

      sum.appendChild(left);
      sum.appendChild(right);

      const body=document.createElement("div");
      body.className="body";

      const built = buildGrid(d, onlyPhase);
      body.appendChild(built.gridWrap);

      if (built.normalized.notes){
        const notes=document.createElement("div");
        notes.className="notes";
        notes.textContent = built.normalized.notes;
        body.appendChild(notes);
      }

      card.appendChild(sum);
      card.appendChild(body);
      listEl.appendChild(card);
    }
  }

  // Expand/Collapse all
  let expanded=false;
  expandBtn.addEventListener("click", ()=>{
    expanded = !expanded;
    document.querySelectorAll("details.card").forEach(d=>d.open = expanded);
  });

  // Debounce search
  let t=null;
  function scheduleRender(){ clearTimeout(t); t=setTimeout(render, 60); }
  qEl.addEventListener("input", scheduleRender);
  groupEl.addEventListener("change", render);
  phaseEl.addEventListener("change", render);

  // Salt a data
  goDateBtn.addEventListener("click", ()=>{
    const v = dateEl.value;
    if(!v) return;
    const d = new Date(v + "T12:00:00");
    selectedCol = Math.max(1, Math.min(24, quinzenaFromDate(d)));
    updateSelInfo();
    render();
    const first = document.querySelector("details.card");
    if(first && !first.open) first.open = true;
  });

  // VALIDACIÓ EXHAUSTIVA + banner
  validateAll();
  if (VALIDATION.errors.length){
    banner.style.display = "block";
    const sample = VALIDATION.errors.slice(0,6).map(e => `${e.cultiu} · ${e.fase}: ${e.ini}→${e.fi}`).join(" | ");
    banner.innerHTML = `<b>⚠ Dades amb codis de quinzena invàlids</b> (${VALIDATION.errors.length}). Exemple: <code>${sample}</code>.`;
  }

  updateSelInfo();
  render();
</script>
</body>
</html>
