<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PrevisiÃ³ Â· MeteoValls (Barri de la Candela, Valls)</title>
  <meta name="description" content="PrevisiÃ³ meteorolÃ²gica per Valls (Alt Camp): horÃ ria d'avui i previsiÃ³ diÃ ria 7 dies (AEMET).">

  <link rel="canonical" href="https://meteocandela.cat/previsio.html">
  <meta name="robots" content="index,follow">
  <meta name="theme-color" content="#0b1220">

  <meta property="og:type" content="article">
  <meta property="og:site_name" content="MeteoCandela">
  <meta property="og:locale" content="ca_ES">
  <meta property="og:title" content="PrevisiÃ³ Â· MeteoValls (Valls Â· Alt Camp)">
  <meta property="og:description" content="PrevisiÃ³ horÃ ria d'avui i previsiÃ³ diÃ ria 7 dies (AEMET).">
  <meta property="og:url" content="https://meteocandela.cat/previsio.html">
  <meta property="og:image" content="https://meteocandela.cat/og-image.png">

  <link rel="stylesheet" href="style.css?v=2026-02-06-01">
</head>

<body>

  <header class="hero hero--small">
    <div class="hero__overlay"></div>
    <div class="hero__content">
      <h1>PrevisiÃ³</h1>
      <p>MeteoValls Â· Valls (Alt Camp)</p>
      <div class="status" id="fxStatus">Carregant previsiÃ³â€¦</div>
    </div>
  </header>

  <main class="grid">

    <section class="card span2">
      <nav class="quick-nav" aria-label="NavegaciÃ³ principal">
        <a href="/index.html" class="quick-nav__btn">ğŸ  Inici</a>
        <a href="/historic.html" class="quick-nav__btn">ğŸ“Š HistÃ²ric</a>
        <a href="/sobre.html" class="quick-nav__btn">â„¹ï¸ Sobre lâ€™estaciÃ³</a>
      </nav>
    </section>

    <!-- RESUM -->
    <section class="card span2">
      <h2>Resum</h2>
      <div class="subs" id="fxMeta">
        <div>Font: â€”</div>
        <div>Actualitzat: â€”</div>
      </div>
    </section>

    <!-- HOURLY -->
    <section class="card span2">
      <h2>PrevisiÃ³ horÃ ria (avui)</h2>
      <div id="hourlyWrap">
        <p class="muted-line">Carregantâ€¦</p>
      </div>
    </section>

    <!-- DAILY -->
    <section class="card span2">
      <h2>PrevisiÃ³ 7 dies</h2>
      <div id="dailyWrap">
        <p class="muted-line">Carregantâ€¦</p>
      </div>
      <p class="muted-line" style="margin-top:12px">
        Nota: previsiÃ³ automÃ tica (pot variar). Dades no oficials per a Ãºs informatiu.
      </p>
    </section>

    <section class="card span2" style="text-align:center">
      <p><a href="/" class="back-link">â† Tornar a MeteoValls</a></p>
    </section>

  </main>

  <footer class="footer">
    <span>Â© <span id="year"></span> MeteoValls</span>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const API_BASE = "/api";
    const FORECAST_URL = `${API_BASE}/forecast`;

    const $ = (id) => document.getElementById(id);

    function fmt1(x){
      const n = Number(x);
      return Number.isFinite(n) ? n.toFixed(1) : "â€”";
    }

    function fmtInt(x){
      const n = Number(x);
      return Number.isFinite(n) ? String(Math.round(n)) : "â€”";
    }

    function fmtDateCA(ymd){
      try{
        const [y,m,d] = String(ymd).slice(0,10).split("-").map(Number);
        const dt = new Date(y, m-1, d);
        return new Intl.DateTimeFormat("ca-ES", { weekday:"short", day:"2-digit", month:"2-digit" }).format(dt);
      }catch{
        return String(ymd || "â€”");
      }
    }

    function timeAgo(ts){
      const n = Number(ts);
      if (!Number.isFinite(n)) return "â€”";
      const mins = Math.round((Date.now() - n) / 60000);
      if (mins < 1) return "fa <1 min";
      if (mins < 60) return `fa ${mins} min`;
      const h = Math.round(mins / 60);
      return `fa ${h} h`;
    }

    async function fetchForecast(){
      const res = await fetch(`${FORECAST_URL}?t=${Date.now()}`, { cache: "no-store" });
      const txt = await res.text();
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${txt.slice(0,140)}`);
      return JSON.parse(txt);
    }

    function skyToIcon(sky){
  const s = String(sky || "").toLowerCase();

  // pluja / ruixats
  if (s.includes("lluv") || s.includes("pluj") || s.includes("chub") || s.includes("precip")) return "ğŸŒ§ï¸";
  // tempesta
  if (s.includes("torment") || s.includes("tempest")) return "â›ˆï¸";
  // neu
  if (s.includes("nieve") || s.includes("neu")) return "ğŸŒ¨ï¸";
  // boira
  if (s.includes("niebla") || s.includes("boira") || s.includes("bruma")) return "ğŸŒ«ï¸";
  // nÃºvols
  if (s.includes("cubierto") || s.includes("muy nub") || s.includes("nuboso")) return "â˜ï¸";
  if (s.includes("intervalos") || s.includes("poco nub")) return "â›…";
  // cel serÃ¨
  if (s.includes("despejado") || s.includes("seren")) return "â˜€ï¸";

  return "â›…";
}

function iconFromSky(s, hourStr){
  const h = Number(String(hourStr || "").slice(0,2));
  const isNight = Number.isFinite(h) ? (h >= 20 || h < 8) : false;

  if (!s) return isNight ? "ğŸŒ™" : "ğŸŒ¤ï¸";
  const t = s.toLowerCase();

  if (t.includes("torment")) return "â›ˆï¸";
  if (t.includes("lluvia") || t.includes("pluja")) return "ğŸŒ§ï¸";
  if (t.includes("nieve") || t.includes("neu")) return "ğŸŒ¨ï¸";
  if (t.includes("niebla") || t.includes("boira")) return "ğŸŒ«ï¸";
  if (t.includes("cubierto")) return "â˜ï¸";
  if (t.includes("nuboso")) return isNight ? "â˜ï¸ğŸŒ™" : "â›…";
  if (t.includes("despejado")) return isNight ? "ğŸŒ™" : "â˜€ï¸";
  return isNight ? "ğŸŒ™" : "ğŸŒ¤ï¸";
}

function fmt0orDash(x){
  const n = Number(x);
  return Number.isFinite(n) ? String(Math.round(n)) : "â€”";
}

function fmtWind(h){
  const v = Number(h.wind_kmh);
  const g = Number(h.gust_kmh);
  const dir = h.wind_dir ? String(h.wind_dir) : "";
  const vTxt = Number.isFinite(v) ? `${Math.round(v)} km/h` : "â€”";
  const gTxt = Number.isFinite(g) ? ` Â· ratxa ${Math.round(g)}` : "";
  const dTxt = dir ? ` ${dir}` : "";
  return `${vTxt}${dTxt}${gTxt}`;
}

function renderHourly(hourly){
  const wrap = $("hourlyWrap");
  if (!wrap) return;

  if (!Array.isArray(hourly) || !hourly.length){
    wrap.innerHTML = `<p class="muted-line">Sense dades horÃ ries disponibles.</p>`;
    return;
  }

  // si hi ha nulls al principi (a vegades AEMET), els deixem igual perÃ² es veurÃ  "â€”"
  wrap.innerHTML = `
    <div class="fx-rail" role="list" aria-label="PrevisiÃ³ per hores">
      ${hourly.map(h => `
        <article class="fx-item" role="listitem">
          <div class="fx-time">${h.hour || "â€”"}</div>
          <div class="fx-icon" aria-hidden="true">${iconFromSky(h.sky, h.hour)}</div>
          <div class="fx-temp">${fmt1(h.temp_c)}Â°</div>

          <div class="fx-row">
            <span class="fx-k">ğŸ’§</span>
            <span class="fx-v">${fmt0orDash(h.pop_pct)}%</span>
          </div>

          <div class="fx-row fx-row--wind">
            <span class="fx-k">ğŸ’¨</span>
            <span class="fx-v">${fmtWind(h)}</span>
          </div>
        </article>
      `).join("")}
    </div>
  `;
}

    function renderDaily(daily){
      const wrap = $("dailyWrap");
      if (!wrap) return;

      if (!Array.isArray(daily) || !daily.length){
        wrap.innerHTML = `<p class="muted-line">Sense dades diÃ ries disponibles.</p>`;
        return;
      }

      wrap.innerHTML = `
        <div class="fx-daily">
          ${daily.map(d => `
            <div class="fx-day">
              <div class="fx-day__left">
                <div class="fx-day__date">${fmtDateCA(d.date)}</div>
                <div class="fx-day__sky">${d.sky || ""}</div>
              </div>
              <div class="fx-day__right">
                <div class="fx-day__temps">
                  <span class="fx-min">${fmt1(d.tmin_c)}Â°</span>
                  <span class="fx-max">${fmt1(d.tmax_c)}Â°</span>
                </div>
                <div class="fx-day__pop">Pluja: ${fmtInt(d.pop_pct)}%</div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    async function main(){
      const status = $("fxStatus");
      const meta = $("fxMeta");

      try{
        const fx = await fetchForecast();

        const provider = fx.provider || "â€”";
        const place = fx.place || "Valls (Alt Camp)";
        const updated = fx.updated_ts ? timeAgo(fx.updated_ts) : "â€”";

        if (status) status.textContent = `PrevisiÃ³: ${place} Â· ${provider} Â· Actualitzat ${updated}.`;
        if (meta) {
          meta.innerHTML = `
            <div>Font: <strong>${provider}</strong></div>
            <div>Actualitzat: <strong>${fx.updated_iso_utc ? fx.updated_iso_utc.replace("T"," ").slice(0,16) : "â€”"}</strong> (${updated})</div>
          `;
        }

        renderHourly(fx.hourly);
        renderDaily(fx.daily);
      } catch(e){
        if (status) status.textContent = "No es pot carregar la previsiÃ³ (/api/forecast).";
        $("hourlyWrap").innerHTML = `<p class="muted-line">Error carregant previsiÃ³.</p>`;
        $("dailyWrap").innerHTML = `<p class="muted-line">Error carregant previsiÃ³.</p>`;
      }
    }

    main();
  </script>

</body>
</html>
